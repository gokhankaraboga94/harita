<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>harita.info | OnaylÄ± YarÄ±ÅŸma</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKkEHHeHnfHSN0MpEcJoK4Ix9o2PFbPY8",
            authDomain: "harita-4b58b.firebaseapp.com",
            projectId: "harita-4b58b",
            storageBucket: "harita-4b58b.firebasestorage.app",
            messagingSenderId: "778047554386",
            appId: "1:778047554386:web:41f29d854399a1d878b08b",
            measurementId: "G-ZNSZZC3HVS",
            databaseURL: "https://harita-4b58b-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        window.db = db;
        window.adaylar = [];

        // Verileri CanlÄ± Dinle
        onValue(ref(db, 'adaylar'), (snapshot) => {
            const data = snapshot.val();
            window.adaylar = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            renderMaps();
            renderAdminPanel(); // Admin paneli de gÃ¼ncellensin
        });

        // Yeni Aday GÃ¶nderme (Pending Status)
        window.submitAday = async () => {
            if(localStorage.getItem('user_has_joined')) return alert("Zaten katÄ±ldÄ±nÄ±z!");
            const gender = document.getElementById('upGender').value;
            const city = parseInt(document.getElementById('upCity').value);
            const name = document.getElementById('upName').value;
            const insta = document.getElementById('upInsta').value; // Yeni Instagram AlanÄ±
            const file = document.getElementById('upFile').files[0];

            if(!city || !name || !file) return alert("LÃ¼tfen zorunlu alanlarÄ± doldurun!");

            try {
                const fileRef = sRef(storage, `adaylar/${Date.now()}_${file.name}`);
                const up = await uploadBytes(fileRef, file);
                const url = await getDownloadURL(up.ref);

                const newAdayRef = push(ref(db, 'adaylar'));
                await update(newAdayRef, { 
                    gender, 
                    city, 
                    name, 
                    img: url, 
                    instagram: insta || "", // BoÅŸ bÄ±rakÄ±labilir
                    votes: 0,
                    status: "pending" // Admin onayÄ± bekliyor
                });
                
                localStorage.setItem('user_has_joined', 'true');
                alert("BaÅŸvurunuz alÄ±ndÄ±! Admin onayÄ±ndan sonra haritada gÃ¶rÃ¼neceksiniz.");
                location.reload();
            } catch (e) { alert("Hata!"); }
        };

        // Admin Onay Fonksiyonu
        window.approveAday = async (id) => {
            await update(ref(db, `adaylar/${id}`), { status: "approved" });
            alert("Aday onaylandÄ± ve haritaya eklendi!");
        };
    </script>

    <style>
        /* ... Ã–nceki CSS kodlarÄ± ... */
        :root { --male: #0084ff; --female: #ff007b; --dark: #121212; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: #f8f9fa; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--dark); color: white; padding: 15px; text-align: center; }
        .tab-controls { display: flex; background: #fff; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; font-weight: bold; cursor: pointer; opacity: 0.5; }
        .active-male { border-bottom: 4px solid var(--male); opacity: 1; color: var(--male); }
        .active-female { border-bottom: 4px solid var(--female); opacity: 1; color: var(--female); }
        .container { display: flex; flex: 1; overflow: hidden; }
        .pane { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
        .pane-male { background: #f0f7ff; }
        .pane-female { background: #fff5f8; }
        svg { width: 100%; max-width: 900px; height: auto; }
        .city-rect { stroke: #ccc; stroke-width: 0.5; cursor: pointer; transition: 0.2s; }
        .city-label { font-size: 8px; font-weight: bold; pointer-events: none; fill: #111; text-shadow: 0 0 2px #fff; }
        
        /* Admin Panel Stili */
        #adminPanel { background: #fff; padding: 20px; border-top: 5px solid red; max-height: 300px; overflow-y: auto; display: none; }
        .admin-card { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding: 10px; }
        
        .insta-tag { color: #e1306c; font-weight: bold; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <h1>harita.info</h1>
    <div id="joinArea"></div>
</header>

<div class="tab-controls">
    <button class="tab-btn active-male" onclick="switchTab('male')">ERKEKLER</button>
    <button class="tab-btn" onclick="switchTab('female')">KADINLAR</button>
</div>

<div class="container">
    <div class="pane pane-male mobile-active" id="paneMale"><div id="svgMale"></div></div>
    <div class="pane pane-female" id="paneFemale"><div id="svgFemale"></div></div>
</div>

<div id="adminPanel">
    <h3>ðŸ“¢ Onay Bekleyenler (Admin Paneli)</h3>
    <div id="pendingList"></div>
</div>

<button onclick="toggleAdmin()" style="position: fixed; bottom: 5px; right: 5px; opacity: 0.3; font-size: 10px;">Admin</button>

<div id="uploadModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:#fff; padding:20px; border-radius:15px; width:90%; max-width:400px;">
        <h3>YarÄ±ÅŸmaya KatÄ±l</h3>
        <select id="upGender"><option value="male">Erkek</option><option value="female">KadÄ±n</option></select>
        <input type="number" id="upCity" placeholder="Plaka (1-81)">
        <input type="text" id="upName" placeholder="Ad Soyad">
        <input type="text" id="upInsta" placeholder="Instagram KullanÄ±cÄ± AdÄ± (Ä°steÄŸe BaÄŸlÄ±)">
        <input type="file" id="upFile" accept="image/*">
        <button onclick="submitAday()" style="width:100%; padding:10px; background:green; color:#fff; border:none; border-radius:8px;">BaÅŸvuruyu Tamamla</button>
        <button onclick="document.getElementById('uploadModal').style.display='none'" style="width:100%; margin-top:10px; border:none; background:none; color:#666;">Ä°ptal</button>
    </div>
</div>

<script>
    const cityNames = ["Adana","AdÄ±yaman","Afyon","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir","Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli","DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari","Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir","Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","K.MaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir","NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat","Trabzon","Tunceli","ÅžanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","KÄ±rÄ±kkale","Batman","ÅžÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"];

    function renderMaps() {
        const draw = (id, gender) => {
            let defs = "<defs>";
            let content = "";
            for (let i = 1; i <= 81; i++) {
                // SADECE ONAYLI VE LÄ°DER OLANLARI BUL
                const leader = window.adaylar.filter(a => a.city == i && a.gender == gender && a.status === 'approved').sort((a,b)=>b.votes-a.votes)[0];
                let fill = "#fff";
                if(leader) {
                    defs += `<pattern id="p-${gender}-${i}" width="1" height="1" patternUnits="objectBoundingBox"><image href="${leader.img}" width="95" height="65" preserveAspectRatio="xMidYMid slice"/></pattern>`;
                    fill = `url(#p-${gender}-${i})`;
                }
                const x = ((i-1)%9)*95; const y = Math.floor((i-1)/9)*65;
                content += `<rect x="${x}" y="${y}" width="90" height="60" class="city-rect" style="fill:${fill}" onclick="openCity(${i},'${gender}')"/>
                            <text x="${x+45}" y="${y+25}" class="city-label">${i}</text>
                            <text x="${x+45}" y="${y+42}" class="city-label" style="font-size:5px; opacity:0.6;">${cityNames[i-1]}</text>`;
            }
            document.getElementById(id).innerHTML = `<svg viewBox="-5 -5 860 600">${defs}</defs>${content}</svg>`;
        };
        draw('svgMale', 'male'); draw('svgFemale', 'female');
    }

    function renderAdminPanel() {
        const pending = window.adaylar.filter(a => a.status === 'pending');
        const list = document.getElementById('pendingList');
        list.innerHTML = pending.map(a => `
            <div class="admin-card">
                <img src="${a.img}" width="40">
                <span>${a.city} - ${a.name}</span>
                <button onclick="approveAday('${a.id}')">ONAYLA</button>
            </div>
        `).join('') || "Bekleyen baÅŸvuru yok.";
    }

    function openCity(cityId, gender) {
        // Sadece OnaylÄ± adaylarÄ± listele
        const filtered = window.adaylar.filter(a => a.city == cityId && a.gender == gender && a.status === 'approved').sort((a,b)=>b.votes-a.votes);
        // ... (Oy verme modalÄ± iÃ§ine Instagram handle'Ä±nÄ± ekle)
        const candidateList = filtered.map(a => `
            <div style="padding:10px; border:1px solid #eee; margin-top:5px; border-radius:10px;">
                <img src="${a.img}" width="50" style="border-radius:50%">
                <b>${a.name}</b> ${a.instagram ? `<span class="insta-tag">(@${a.instagram})</span>` : ''}
                <button onclick="vote('${a.id}')">Oy Ver</button>
            </div>
        `).join('');
        // Modal gÃ¶sterim kodlarÄ±...
    }

    function toggleAdmin() {
        const p = document.getElementById('adminPanel');
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
    }
</script>
</body>
</html>
