<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>harita.info | TÃ¼rkiye'nin Enleri</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKkEHHeHnfHSN0MpEcJoK4Ix9o2PFbPY8",
            authDomain: "harita-4b58b.firebaseapp.com",
            projectId: "harita-4b58b",
            storageBucket: "harita-4b58b.firebasestorage.app",
            messagingSenderId: "778047554386",
            appId: "1:778047554386:web:41f29d854399a1d878b08b",
            measurementId: "G-ZNSZZC3HVS",
            databaseURL: "https://harita-4b58b-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.adaylar = [];
        window.bekleyenAdaylar = [];

        // OnaylÄ± Adaylar
        onValue(ref(db, 'adaylar'), (snapshot) => {
            const data = snapshot.val();
            window.adaylar = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            renderMaps();
        });

        // Bekleyen Adaylar (Moderasyon)
        onValue(ref(db, 'bekleyen_adaylar'), (snapshot) => {
            const data = snapshot.val();
            window.bekleyenAdaylar = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            if(isAdminPage()) renderModPanel();
        });

        // GÃ¶rsel Base64'e Ã‡evirme
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // YarÄ±ÅŸmacÄ± BaÅŸvurusu
        window.submitAday = async () => {
            if(localStorage.getItem('user_has_joined')) return alert("Zaten katÄ±ldÄ±nÄ±z!");
            
            const gender = document.getElementById('upGender').value;
            const city = parseInt(document.getElementById('upCity').value);
            const name = document.getElementById('upName').value;
            const instagram = document.getElementById('upInstagram').value.trim();
            const file = document.getElementById('upFile').files[0];

            if(!city || !name || !file || city < 1 || city > 81) {
                return alert("LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun!");
            }

            if(file.size > 1024 * 1024) {
                return alert("GÃ¶rsel boyutu 1MB'dan kÃ¼Ã§Ã¼k olmalÄ±!");
            }

            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').innerText = "YÃ¼kleniyor...";

                const base64 = await fileToBase64(file);

                const newAdayRef = push(ref(db, 'bekleyen_adaylar'));
                await update(newAdayRef, { 
                    gender, 
                    city, 
                    name, 
                    instagram: instagram || null,
                    img: base64,
                    votes: 0,
                    status: 'pending',
                    createdAt: Date.now()
                });
                
                localStorage.setItem('user_has_joined', 'true');
                alert("BaÅŸvurunuz alÄ±ndÄ±! Admin onayÄ±ndan sonra yayÄ±nlanacak.");
                document.getElementById('uploadModal').style.display = 'none';
                location.reload();
            } catch (e) { 
                alert("Hata: " + e.message); 
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerText = "ğŸ“¤ BaÅŸvuruyu GÃ¶nder";
            }
        };

        // Oy Verme
        window.vote = async (id) => {
            if(localStorage.getItem('voted_' + id)) return alert("Zaten oy verdiniz!");
            const aday = window.adaylar.find(a => a.id === id);
            await update(ref(db, `adaylar/${id}`), { votes: (aday.votes || 0) + 1 });
            localStorage.setItem('voted_' + id, 'true');
            alert("Oyunuz kaydedildi!");
            document.getElementById('voteModal').style.display = 'none';
        };

        // Admin: BaÅŸvuruyu Onayla
        window.approveAday = async (id) => {
            const aday = window.bekleyenAdaylar.find(a => a.id === id);
            if(!aday) return;
            
            const newAdayRef = push(ref(db, 'adaylar'));
            await update(newAdayRef, { 
                gender: aday.gender,
                city: aday.city,
                name: aday.name,
                instagram: aday.instagram,
                img: aday.img,
                votes: 0
            });
            
            await remove(ref(db, `bekleyen_adaylar/${id}`));
            alert("BaÅŸvuru onaylandÄ±!");
        };

        // Admin: BaÅŸvuruyu Reddet
        window.rejectAday = async (id) => {
            if(!confirm("Bu baÅŸvuruyu reddetmek istediÄŸinize emin misiniz?")) return;
            await remove(ref(db, `bekleyen_adaylar/${id}`));
            alert("BaÅŸvuru reddedildi.");
        };

        // Admin Panelini Render Et
        window.renderModPanel = () => {
            const panel = document.getElementById('modPanel');
            if(!panel) return;
            
            const count = document.getElementById('pendingCount');
            if(count) count.innerText = window.bekleyenAdaylar.length;
            
            if(window.bekleyenAdaylar.length === 0) {
                panel.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Bekleyen baÅŸvuru yok.</p>';
                return;
            }

            panel.innerHTML = window.bekleyenAdaylar.map(a => `
                <div style="border:1px solid #ddd; border-radius:10px; padding:15px; margin-bottom:15px; background:#fff;">
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                        <img src="${a.img}" style="width:80px; height:80px; border-radius:10px; object-fit:cover;">
                        <div style="flex:1;">
                            <h3 style="margin:0 0 5px 0;">${a.name}</h3>
                            <p style="margin:0; color:#666; font-size:14px;">
                                <strong>Åehir:</strong> ${a.city} - ${window.cityNames[a.city-1]}<br>
                                <strong>Cinsiyet:</strong> ${a.gender === 'male' ? 'Erkek' : 'KadÄ±n'}<br>
                                ${a.instagram ? `<strong>Instagram:</strong> <a href="https://instagram.com/${a.instagram.replace('@','')}" target="_blank">@${a.instagram.replace('@','')}</a>` : '<em>Instagram yok</em>'}
                            </p>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="approveAday('${a.id}')" style="flex:1; background:#28a745; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold;">âœ“ Onayla</button>
                        <button onclick="rejectAday('${a.id}')" style="flex:1; background:#dc3545; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold;">âœ— Reddet</button>
                    </div>
                </div>
            `).join('');
        };

        // Sayfa yÃ¶nlendirmesi
        function isAdminPage() {
            return window.location.pathname === '/adminpanel' || window.location.hash === '#/adminpanel';
        }

        // Sayfa yÃ¼klendiÄŸinde kontrol
        window.addEventListener('load', () => {
            if(isAdminPage()) {
                document.getElementById('mainPage').style.display = 'none';
                document.getElementById('adminPage').style.display = 'block';
                document.title = 'Admin Panel | harita.info';
                renderModPanel();
            }
        });
    </script>

    <style>
        :root { --male: #0084ff; --female: #ff007b; --dark: #121212; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: #f8f9fa; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: var(--dark); color: white; padding: 15px; text-align: center; position: relative; }
        .tab-controls { display: flex; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; font-weight: bold; cursor: pointer; opacity: 0.5; background: white; }
        .active-male { border-bottom: 4px solid var(--male); opacity: 1; color: var(--male); }
        .active-female { border-bottom: 4px solid var(--female); opacity: 1; color: var(--female); }
        .container { display: flex; flex: 1; overflow: hidden; }
        .pane { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
        .pane-male { background: #f0f7ff; }
        .pane-female { background: #fff5f8; }
        svg { width: 100%; max-width: 900px; height: auto; }
        .city-rect { stroke: #ccc; stroke-width: 0.5; cursor: pointer; transition: 0.2s; }
        .city-rect:hover { stroke: #333; stroke-width: 1.5; }
        .city-label { font-size: 8px; font-weight: bold; pointer-events: none; fill: #111; text-shadow: 0 0 2px #fff; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 15px; }
        .modal-content { background: #fff; padding: 25px; border-radius: 15px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .btn-main { background: #ff9800; color: #fff; padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; }
        .instagram-info { background: #f0f0f0; padding: 10px; border-radius: 8px; font-size: 12px; color: #666; margin: 5px 0; }
        .admin-page { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .candidate-instagram { color: #E4405F; font-weight: 600; text-decoration: none; font-size: 11px; }
        .candidate-instagram:hover { text-decoration: underline; }
        @media (max-width: 768px) { 
            .pane { display: none; } 
            .pane.mobile-active { display: flex; }
        }
    </style>
</head>
<body>

<div id="mainPage">
    <header>
        <h1>harita.info</h1>
        <div id="joinArea"></div>
    </header>

    <div class="tab-controls">
        <button class="tab-btn active-male" id="btnM" onclick="switchTab('male')">ERKEKLER</button>
        <button class="tab-btn" id="btnF" onclick="switchTab('female')">KADINLAR</button>
    </div>

    <div class="container">
        <div class="pane pane-male mobile-active" id="paneMale"><div id="svgMale"></div></div>
        <div class="pane pane-female" id="paneFemale"><div id="svgFemale"></div></div>
    </div>
</div>

<div id="adminPage" style="display:none;">
    <header style="background:#dc3545;">
        <h1>ğŸ” Moderasyon Paneli</h1>
        <a href="/" style="color:white; text-decoration:none; font-size:14px;">â† Ana Sayfa</a>
    </header>
    <div class="admin-page">
        <h2 style="margin-bottom:20px;">Bekleyen BaÅŸvurular (<span id="pendingCount">0</span>)</h2>
        <div id="modPanel"></div>
    </div>
</div>

<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ† YarÄ±ÅŸmaya KatÄ±l</h3>
        <select id="upGender">
            <option value="male">ğŸ‘¨ Erkek</option>
            <option value="female">ğŸ‘© KadÄ±n</option>
        </select>
        <input type="number" id="upCity" placeholder="Ä°l Plaka Kodu (1-81)" min="1" max="81">
        <input type="text" id="upName" placeholder="Ad Soyad">
        <input type="text" id="upInstagram" placeholder="Instagram KullanÄ±cÄ± AdÄ± (Ä°steÄŸe BaÄŸlÄ±)">
        <div class="instagram-info">
            ğŸ’¡ Instagram hesabÄ±nÄ±zÄ± eklerseniz, kazandÄ±ÄŸÄ±nÄ±zda profiliniz gÃ¶rÃ¼ntÃ¼lenecek. (Opsiyonel)
        </div>
        <input type="file" id="upFile" accept="image/*">
        <div style="font-size:12px; color:#999; margin-top:5px;">
            âš ï¸ GÃ¶rsel boyutu maksimum 1MB olmalÄ±dÄ±r
        </div>
        <button class="btn-main" id="submitBtn" style="width:100%; background:#28a745;" onclick="submitAday()">ğŸ“¤ BaÅŸvuruyu GÃ¶nder</button>
        <button onclick="document.getElementById('uploadModal').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; color:#666; cursor:pointer;">Ä°ptal</button>
    </div>
</div>

<div id="voteModal" class="modal">
    <div class="modal-content">
        <h3 id="vTitle">Åehir AdaylarÄ±</h3>
        <div id="candidateList" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
        <button onclick="document.getElementById('voteModal').style.display='none'" style="width:100%; margin-top:15px; padding:10px;">Kapat</button>
    </div>
</div>

<script>
    const cityNames = ["Adana","AdÄ±yaman","Afyon","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir","Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli","DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari","Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir","Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","K.MaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir","NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat","Trabzon","Tunceli","ÅanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","KÄ±rÄ±kkale","Batman","ÅÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"];
    
    window.cityNames = cityNames;

    function switchTab(g) {
        document.getElementById('paneMale').classList.toggle('mobile-active', g === 'male');
        document.getElementById('paneFemale').classList.toggle('mobile-active', g === 'female');
        document.getElementById('btnM').classList.toggle('active-male', g === 'male');
        document.getElementById('btnF').classList.toggle('active-female', g === 'female');
    }

    function renderMaps() {
        const draw = (id, gender) => {
            let defs = "<defs>";
            let content = "";
            for (let i = 1; i <= 81; i++) {
                const leader = (window.adaylar || []).filter(a => a.city == i && a.gender == gender).sort((a,b)=>b.votes-a.votes)[0];
                let fill = "#fff";
                if(leader) {
                    defs += `<pattern id="p-${gender}-${i}" width="1" height="1" patternUnits="objectBoundingBox"><image href="${leader.img}" width="95" height="65" preserveAspectRatio="xMidYMid slice"/></pattern>`;
                    fill = `url(#p-${gender}-${i})`;
                }
                const x = ((i-1)%9)*95; 
                const y = Math.floor((i-1)/9)*65;
                content += `<rect x="${x}" y="${y}" width="90" height="60" class="city-rect" style="fill:${fill}" onclick="openCity(${i},'${gender}')"/>
                <text x="${x+45}" y="${y+25}" class="city-label">${i}</text>
                <text x="${x+45}" y="${y+42}" class="city-label" style="font-size:5px; opacity:0.6;">${cityNames[i-1]}</text>`;
            }
            const svgEl = document.getElementById(id);
            if(svgEl) svgEl.innerHTML = `<svg viewBox="-5 -5 860 600">${defs}</defs>${content}</svg>`;
        };
        draw('svgMale', 'male'); 
        draw('svgFemale', 'female');
        updateBtn();
    }

    function updateBtn() {
        const joinArea = document.getElementById('joinArea');
        if(!joinArea) return;
        if(localStorage.getItem('user_has_joined')) {
            joinArea.innerHTML = `<button class="btn-main" style="background:#28a745" disabled>âœ“ BaÅŸvurunuz AlÄ±ndÄ±</button>`;
        } else {
            joinArea.innerHTML = `<button class="btn-main" onclick="document.getElementById('uploadModal').style.display='flex'">ğŸ† YarÄ±ÅŸmacÄ± Ol</button>`;
        }
    }

    function openCity(cityId, gender) {
        const filtered = (window.adaylar || []).filter(a => a.city == cityId && a.gender == gender).sort((a,b)=>b.votes-a.votes);
        document.getElementById('vTitle').innerText = cityId + " - " + cityNames[cityId-1] + " AdaylarÄ±";
        const list = document.getElementById('candidateList');
        
        if(filtered.length === 0) {
            list.innerHTML = "<p style='text-align:center; padding:20px; color:#999;'>Bu ÅŸehirde henÃ¼z aday yok.</p>";
        } else {
            list.innerHTML = filtered.map((a, idx) => `
                <div style="display:flex; align-items:center; margin-bottom:12px; padding:12px; border:1px solid ${idx === 0 ? '#ffd700' : '#eee'}; border-radius:10px; background:${idx === 0 ? '#fffbf0' : 'white'};">
                    ${idx === 0 ? '<span style="font-size:24px; margin-right:8px;">ğŸ‘‘</span>' : ''}
                    <img src="${a.img}" style="width:60px; height:60px; border-radius:50%; object-fit:cover; margin-right:12px; border:2px solid ${idx === 0 ? '#ffd700' : '#ddd'};">
                    <div style="flex:1;">
                        <b style="font-size:15px;">${a.name}</b>
                        ${a.instagram ? `<br><a href="https://instagram.com/${a.instagram.replace('@','')}" target="_blank" class="candidate-instagram">ğŸ“· @${a.instagram.replace('@','')}</a>` : ''}
                        <br><small style="color:#666;">${a.votes} Oy</small>
                    </div>
                    <button onclick="vote('${a.id}')" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:bold; box-shadow:0 2px 8px rgba(102,126,234,0.3);">
                        â­ Oy Ver
                    </button>
                </div>
            `).join('');
        }
        
        document.getElementById('voteModal').style.display = 'flex';
    }

    // Ä°lk render
    renderMaps();
    updateBtn();
</script>
</body>
</html>
